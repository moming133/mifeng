<!-- pages/chat/chat.wxml -->
<view class="container">
    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
    <scroll-view class="chat-area" scroll-y scroll-into-view="{{toView}}" scroll-top="{{scrollTop}}" bindscrolltoupper="loadMore" bindscrolltolower="loadMore">
        <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
        <view class="system-message" wx:if="{{chatMessages.length === 0}}">
            <text class="system-text">æ¬¢è¿ä½¿ç”¨å°æ™ºAIï¼Œå¼€å§‹å¯¹è¯å§ï¼</text>
        </view>
        <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
        <view class="message-list">
            <view wx:for="{{chatMessages}}" wx:key="timestamp" id="msg-{{index}}" class="message-item {{item.role === 'user' ? 'user-message' : 'ai-message'}}">
                <!-- ç”¨æˆ·æ¶ˆæ¯ -->
                <view wx:if="{{item.role === 'user'}}" class="message-content user-content">
                    <text class="message-text">{{item.message}}</text>
                    <text class="message-time">{{formatTime(item.timestamp)}}</text>
                </view>
                <!-- AIæ¶ˆæ¯ -->
                <view wx:else class="message-content ai-content">
                    <view class="ai-header">
                        <text class="ai-avatar">ğŸ¤–</text>
                        <text class="ai-name">å°æ™ºAI</text>
                        <view class="typing-indicator" wx:if="{{isTyping && index === chatMessages.length - 1}}">
                            <view class="typing-dot"></view>
                            <view class="typing-dot"></view>
                            <view class="typing-dot"></view>
                        </view>
                    </view>
                    <text class="message-text">{{item.message}}</text>
                    <text class="message-time">{{formatTime(item.timestamp)}}</text>
                </view>
            </view>
        </view>
        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <view class="loading-indicator" wx:if="{{loading}}">
            <view class="loading-spinner"></view>
            <text class="loading-text">æ­£åœ¨æ€è€ƒ...</text>
        </view>
        <!-- æ‰“å­—æŒ‡ç¤ºå™¨ -->
        <view class="typing-indicator-container" wx:if="{{isTyping && !loading}}">
            <view class="typing-indicator">
                <view class="typing-dot"></view>
                <view class="typing-dot"></view>
                <view class="typing-dot"></view>
            </view>
            <text class="typing-text">å°æ™ºæ­£åœ¨è¾“å…¥...</text>
        </view>
    </scroll-view>
    <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
    <view class="input-area">
        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <view class="status-bar">
            <view class="status-item connection-status">
                <view class="status-indicator {{isConnected ? 'connected' : 'disconnected'}}"></view>
                <text class="status-text">{{isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}}</text>
            </view>
            <view class="status-item device-status">
                <view class="status-indicator status-{{deviceState}}"></view>
                <text class="status-text">{{getDeviceStatusText(deviceState)}}</text>
            </view>
            <view class="status-item emotion-status">
                <text class="emotion-emoji">{{getEmotionEmoji(emotion)}}</text>
            </view>
        </view>
        <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
        <view class="input-container">
            <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
            <view class="input-wrapper">
                <input class="text-input" placeholder="è¾“å…¥æ¶ˆæ¯..." value="{{inputValue}}" bindinput="onInputChange" bindconfirm="sendText" disabled="{{!hasNetwork || !isConnected}}" />
            </view>
            <!-- å‘é€æŒ‰é’® -->
            <view class="send-button {{inputValue.trim() && isConnected ? 'active' : ''}}" bindtap="sendText">
                <text class="send-icon">å‘é€</text>
            </view>
        </view>
        <!-- æ“ä½œæŒ‰é’® -->
        <view class="action-buttons">
            <view class="action-button" bindtap="clearChat">
                <text class="action-icon">ğŸ—‘ï¸</text>
                <text class="action-text">æ¸…ç©º</text>
            </view>
            <view class="action-button" bindtap="shareChat">
                <text class="action-icon">ğŸ“¤</text>
                <text class="action-text">åˆ†äº«</text>
            </view>
            <view class="action-button" bindtap="abortSpeaking" wx:if="{{deviceState === 'speaking'}}">
                <text class="action-icon">â¹ï¸</text>
                <text class="action-text">åœæ­¢</text>
            </view>
        </view>
    </view>
</view>