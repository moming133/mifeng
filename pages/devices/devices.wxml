<!-- pages/devices/devices.wxml -->
<view class="container">
    <!-- ÊêúÁ¥¢Ê†è -->
    <view class="search-bar">
        <view class="search-input-wrapper">
            <text class="search-icon">üîç</text>
            <input class="search-input" placeholder="ÊêúÁ¥¢ËÆæÂ§á..." value="{{searchQuery}}" bindinput="onSearch" />
        </view>
    </view>
    <!-- ËÆæÂ§áÂàÜÁ±ª -->
    <view class="category-tabs">
        <view wx:for="{{deviceCategories}}" wx:key="id" class="category-tab {{currentCategory === item.id ? 'active' : ''}}" bindtap="switchCategory" data-category="{{item.id}}">
            {{item.name}}
        </view>
    </view>
    <!-- ËÆæÂ§áÂàóË°® -->
    <view class="devices-container">
        <!-- ËìùÁâôËÆæÂ§áÂèëÁé∞Áä∂ÊÄÅ -->
        <view wx:if="{{discovering}}" class="discovery-status">
            <text class="discovery-icon">üîç</text>
            <text class="discovery-text">Ê≠£Âú®ÊêúÁ¥¢ËìùÁâôËÆæÂ§á...</text>
            <text class="discovery-count">Â∑≤ÂèëÁé∞ {{bleDevices.length}} ‰∏™ËÆæÂ§á</text>
        </view>

        <!-- ËìùÁâôËÆæÂ§áÂàóË°® -->
        <view wx:if="{{bleDevices.length > 0}}" class="ble-devices-list">
            <view wx:for="{{bleDevices}}" wx:key="deviceId" class="ble-device-item">
                <view class="ble-device-info">
                    <text class="ble-device-name">{{item.name}}</text>
                    <text class="ble-device-id">{{item.deviceId}}</text>
                </view>
                <button
                    class="connect-btn {{connectedDeviceId === item.deviceId ? 'connected' : ''}}"
                    bindtap="connectDevice"
                    data-device-id="{{item.deviceId}}"
                >
                    {{connectedDeviceId === item.deviceId ? 'Â∑≤ËøûÊé•' : 'ËøûÊé•'}}
                </button>
            </view>
        </view>

        <!-- Êô∫ËÉΩËÆæÂ§áÂàóË°® -->
        <view wx:if="{{filteredDevices.length === 0 && bleDevices.length === 0}}" class="empty-state">
            <text class="empty-icon">üè†</text>
            <text class="empty-text">ÊöÇÊó†ËÆæÂ§á</text>
            <button class="add-device-btn" bindtap="addDevice">Ê∑ªÂä†ËÆæÂ§á</button>
        </view>
        <view wx:elif="{{filteredDevices.length > 0}}" class="devices-list">
            <!-- ÊåâÊàøÈó¥ÂàÜÁªÑÊòæÁ§∫ -->
            <block wx:for="{{roomDevices}}" wx:key="*this">
                <view class="room-section">
                    <view class="room-header">
                        <text class="room-name">{{item.key}}</text>
                        <text class="room-count">{{item.value.length}}‰∏™ËÆæÂ§á</text>
                    </view>
                    <view class="room-devices">
                        <view wx:for="{{item.value}}" wx:key="id" class="device-card">
                            <!-- ËÆæÂ§áÂõæÊ†áÂíåÁä∂ÊÄÅ -->
                            <view class="device-header">
                                <view class="device-icon-wrapper">
                                    <text class="device-icon">{{item.icon}}</text>
                                    <view class="device-status-indicator" style="background-color: {{getDeviceStatusColor(item.status)}}"></view>
                                </view>
                                <view class="device-actions">
                                    <view wx:if="{{item.status !== 'online' && !connectedDeviceId}}" class="action-btn connect-btn" bindtap="connectDevice" data-device-id="{{item.id}}">
                                        <text class="btn-icon">üîó</text>
                                    </view>
                                    <view wx:if="{{item.status === 'online' || connectedDeviceId}}" class="action-btn disconnect-btn" bindtap="disconnectDevice" data-device-id="{{item.id}}">
                                        <text class="btn-icon">üîå</text>
                                    </view>
                                    <view class="action-btn delete-btn" bindtap="deleteDevice" data-device-id="{{item.id}}">
                                        <text class="btn-icon">üóëÔ∏è</text>
                                    </view>
                                </view>
                            </view>
                            <!-- ËÆæÂ§á‰ø°ÊÅØ -->
                            <view class="device-info">
                                <text class="device-name">{{item.name}}</text>
                                <view class="device-status">
                                    <text class="status-text" style="color: {{getDeviceStatusColor(item.status)}}">
                                        {{getDeviceStatusText(item.status)}}
                                    </text>
                                    <text class="update-time">
                                        {{formatTime(item.lastUpdated)}}
                                    </text>
                                </view>
                            </view>
                            <!-- ËÆæÂ§áÊéßÂà∂ -->
                            <view class="device-controls" wx:if="{{item.status === 'online'}}">
                                <!-- ÁÅØÂÖâÊéßÂà∂ -->
                                <view wx:if="{{item.type === 'light'}}" class="control-group">
                                    <view class="control-label">‰∫ÆÂ∫¶</view>
                                    <slider class="brightness-slider" min="0" max="100" value="{{item.brightness}}" bindchange="adjustBrightness" data-device-id="{{item.id}}" activeColor="#ffeb3b" backgroundColor="#f0f0f0" />
                                    <text class="brightness-value">{{item.brightness}}%</text>
                                </view>
                                <!-- Èü≥ÂìçÊéßÂà∂ -->
                                <view wx:if="{{item.type === 'speaker'}}" class="control-group">
                                    <view class="control-label">Èü≥Èáè</view>
                                    <slider class="volume-slider" min="0" max="100" value="{{item.volume}}" bindchange="adjustVolume" data-device-id="{{item.id}}" activeColor="#07c160" backgroundColor="#f0f0f0" />
                                    <text class="volume-value">{{item.volume}}%</text>
                                </view>
                                <!-- Á©∫Ë∞ÉÊéßÂà∂ -->
                                <view wx:if="{{item.type === 'air_conditioner'}}" class="control-group">
                                    <view class="control-label">Ê∏©Â∫¶</view>
                                    <view class="temperature-controls">
                                        <view class="temp-btn {{item.temperature > 16 ? '' : 'disabled'}}" bindtap="setTemperature" data-device-id="{{item.id}}" data-value="{{item.temperature - 1}}">
                                            <text class="temp-icon">‚ùÑÔ∏è</text>
                                        </view>
                                        <text class="temperature-value">
                                            {{item.temperature}}¬∞C
                                        </text>
                                        <view class="temp-btn {{item.temperature < 30 ? '' : 'disabled'}}" bindtap="setTemperature" data-device-id="{{item.id}}" data-value="{{item.temperature + 1}}">
                                            <text class="temp-icon">üî•</text>
                                        </view>
                                    </view>
                                </view>
                                <!-- ‰º†ÊÑüÂô®ÊòæÁ§∫ -->
                                <view wx:if="{{item.type === 'sensor'}}" class="sensor-info">
                                    <view class="sensor-item">
                                        <text class="sensor-label">Ê∏©Â∫¶</text>
                                        <text class="sensor-value">{{item.temperature}}¬∞C</text>
                                    </view>
                                    <view class="sensor-item">
                                        <text class="sensor-label">ÊπøÂ∫¶</text>
                                        <text class="sensor-value">{{item.humidity}}%</text>
                                    </view>
                                </view>
                                <!-- ÊëÑÂÉèÂ§¥ÊéßÂà∂ -->
                                <view wx:if="{{item.type === 'camera'}}" class="camera-controls">
                                    <view class="camera-status">
                                        <text class="status-label">ÂΩïÂà∂Áä∂ÊÄÅ</text>
                                        <text class="status-value {{item.recording ? 'recording' : ''}}">
                                            {{item.recording ? 'ÂΩïÂà∂‰∏≠' : 'Êú™ÂΩïÂà∂'}}
                                        </text>
                                    </view>
                                    <button class="camera-btn live-btn">Êü•ÁúãÁõ¥Êí≠</button>
                                </view>
                            </view>
                            <!-- ‰∏ªÂºÄÂÖ≥ -->
                            <view class="device-main-switch" wx:if="{{item.type !== 'sensor'}}">
                                <view class="main-switch {{item.status === 'on' ? 'on' : 'off'}}" bindtap="toggleDevice" data-device-id="{{item.id}}">
                                    <view class="switch-handle {{item.status === 'on' ? 'on' : ''}}"></view>
                                </view>
                                <text class="switch-label">
                                    {{item.status === 'on' ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}}
                                </text>
                            </view>
                        </view>
                    </view>
                </view>
            </block>
        </view>
    </view>
    <!-- Ê∑ªÂä†ËÆæÂ§áÊåâÈíÆ -->
    <view class="add-device-fab" bindtap="addDevice">
        <text class="fab-icon">+</text>
    </view>
</view>